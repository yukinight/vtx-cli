var BMapLib=window.BMapLib=BMapLib||{};(function(){var c=c||{guid:"$BAIDU$"};(function(){window[c.guid]={};c.extend=function(g,e){for(var f in e){if(e.hasOwnProperty(f)){g[f]=e[f]}}return g};c.lang=c.lang||{};c.lang.guid=function(){return"TANGRAM__"+(window[c.guid]._counter++).toString(36)};window[c.guid]._counter=window[c.guid]._counter||1;window[c.guid]._instances=window[c.guid]._instances||{};c.lang.Class=function(e){this.guid=e||c.lang.guid();window[c.guid]._instances[this.guid]=this};window[c.guid]._instances=window[c.guid]._instances||{};c.lang.isString=function(e){return"[object String]"==Object.prototype.toString.call(e)};c.lang.isFunction=function(e){return"[object Function]"==Object.prototype.toString.call(e)};c.lang.Class.prototype.toString=function(){return"[object "+(this._className||"Object")+"]"};c.lang.Class.prototype.dispose=function(){delete window[c.guid]._instances[this.guid];for(var e in this){if(!c.lang.isFunction(this[e])){delete this[e]}}this.disposed=true};c.lang.Event=function(e,f){this.type=e;this.returnValue=true;this.target=f||null;this.currentTarget=null};c.lang.Class.prototype.addEventListener=function(h,g,f){if(!c.lang.isFunction(g)){return}!this.__listeners&&(this.__listeners={});var e=this.__listeners,i;if(typeof f=="string"&&f){if(/[^\w\-]/.test(f)){throw ("nonstandard key:"+f)}else{g.hashCode=f;i=f}}h.indexOf("on")!=0&&(h="on"+h);typeof e[h]!="object"&&(e[h]={});i=i||c.lang.guid();g.hashCode=i;e[h][i]=g};c.lang.Class.prototype.removeEventListener=function(g,f){if(c.lang.isFunction(f)){f=f.hashCode}else{if(!c.lang.isString(f)){return}}!this.__listeners&&(this.__listeners={});g.indexOf("on")!=0&&(g="on"+g);var e=this.__listeners;if(!e[g]){return}e[g][f]&&delete e[g][f]};c.lang.Class.prototype.dispatchEvent=function(h,e){if(c.lang.isString(h)){h=new c.lang.Event(h)}!this.__listeners&&(this.__listeners={});e=e||{};for(var g in e){h[g]=e[g]}var g,f=this.__listeners,j=h.type;h.target=h.target||this;h.currentTarget=this;j.indexOf("on")!=0&&(j="on"+j);c.lang.isFunction(this[j])&&this[j].apply(this,arguments);if(typeof f[j]=="object"){for(g in f[j]){f[j][g].apply(this,arguments)}}return h.returnValue};c.lang.inherits=function(k,i,h){var g,j,e=k.prototype,f=new Function();f.prototype=i.prototype;j=k.prototype=new f();for(g in e){j[g]=e[g]}k.prototype.constructor=k;k.superClass=i.prototype;if("string"==typeof h){j._className=h}};c.dom=c.dom||{};c._g=c.dom._g=function(e){if(c.lang.isString(e)){return document.getElementById(e)}return e};c.g=c.dom.g=function(e){if("string"==typeof e||e instanceof String){return document.getElementById(e)}else{if(e&&e.nodeName&&(e.nodeType==1||e.nodeType==9)){return e}}return null};c.insertHTML=c.dom.insertHTML=function(h,e,g){h=c.dom.g(h);var f,i;if(h.insertAdjacentHTML){h.insertAdjacentHTML(e,g)}else{f=h.ownerDocument.createRange();e=e.toUpperCase();if(e=="AFTERBEGIN"||e=="BEFOREEND"){f.selectNodeContents(h);f.collapse(e=="AFTERBEGIN")}else{i=e=="BEFOREBEGIN";f[i?"setStartBefore":"setEndAfter"](h);f.collapse(i)}f.insertNode(f.createContextualFragment(g))}return h};c.ac=c.dom.addClass=function(k,m){k=c.dom.g(k);var f=m.split(/\s+/),e=k.className,j=" "+e+" ",h=0,g=f.length;for(;h<g;h++){if(j.indexOf(" "+f[h]+" ")<0){e+=(e?" ":"")+f[h]}}k.className=e;return k};c.event=c.event||{};c.event._listeners=c.event._listeners||[];c.on=c.event.on=function(f,i,k){i=i.replace(/^on/i,"");f=c._g(f);var j=function(m){k.call(f,m)},e=c.event._listeners,h=c.event._eventFilter,l,g=i;i=i.toLowerCase();if(h&&h[i]){l=h[i](f,i,j);g=l.type;j=l.listener}if(f.addEventListener){f.addEventListener(g,j,false)}else{if(f.attachEvent){f.attachEvent("on"+g,j)}}e[e.length]=[f,i,k,j,g];return f};c.un=c.event.un=function(g,j,f){g=c._g(g);j=j.replace(/^on/i,"").toLowerCase();var m=c.event._listeners,h=m.length,i=!f,l,k,e;while(h--){l=m[h];if(l[1]===j&&l[0]===g&&(i||l[2]===f)){k=l[4];e=l[3];if(g.removeEventListener){g.removeEventListener(k,e,false)}else{if(g.detachEvent){g.detachEvent("on"+k,e)}}m.splice(h,1)}}return g};c.preventDefault=c.event.preventDefault=function(e){if(e.preventDefault){e.preventDefault()}else{e.returnValue=false}}})();var d=BMapLib.DistanceTool=function(f,e){if(!f){return}this._map=f;e=e||{};this._opts=c.extend(c.extend(this._opts||{},{tips:"测距",followText:"单击确定地点，双击结束",unit:"metric",lineColor:"#ff6319",lineStroke:2,opacity:0.8,lineStyle:"solid",cursor:"http://api.map.baidu.com/images/ruler.cur",secIcon:null,closeIcon:null}),e);this._followTitle=null;this._points=[];this._paths=[];this._dots=[];this._segDistance=[];this._overlays=[];this._enableMassClear=true,this._units={metric:{name:"metric",conv:1,incon:1000,u1:"米",u2:"公里"},us:{name:"us",conv:3.2808,incon:5279.856,u1:"英尺",u2:"英里"}};this._isOpen=false;this._startFollowText="单击确定起点";this._movingTimerId=null;this._styles={"BMapLib_diso":"height:17px;width:5px;position:absolute;background:url(http://api.map.baidu.com/images/dis_box_01.gif) no-repeat left top","BMapLib_disi":"color:#7a7a7a;position:absolute;left:5px;padding:0 4px 1px 0;line-height:17px;background:url(http://api.map.baidu.com/images/dis_box_01.gif) no-repeat right top","BMapLib_disBoxDis":"color:#ff6319;font-weight:bold"};
if(this._opts.lineStroke<=0){this._opts.lineStroke=2}if(this._opts.opacity>1){this._opts.opacity=1}else{if(this._opts.opacity<0){this._opts.opacity=0}}if(this._opts.lineStyle!="solid"&&this._opts.lineStyle!="dashed"){this._opts.lineStyle="solid"}if(!this._units[this._opts.unit]){this._opts.unit="metric"}this.text="测距"};c.lang.inherits(d,c.lang.Class,"DistanceTool");d.prototype._bind=function(){this._setCursor(this._opts.cursor);var f=this;c.on(this._map.getContainer(),"mousemove",function(i){if(!f._isOpen){return}if(!f._followTitle){return}i=window.event||i;var g=i.target||i.srcElement;if(g!=a.getDom(f._map)){f._followTitle.hide();return}if(!f._mapMoving){f._followTitle.show()}var h=a.getDrawPoint(i,true);f._followTitle.setPosition(h)});if(this._startFollowText){var e=this._followTitle=new BMap.Label(this._startFollowText,{offset:new BMap.Size(14,16)});this._followTitle.setStyles({color:"#333",borderColor:"#ff0103"})}};d.prototype.open=function(e){this._map=e;if(this._isOpen==true){return true}if(!!BMapLib._toolInUse){return}this._isOpen=true;BMapLib._toolInUse=true;if(this._mapMoving){delete this._mapMoving}var i=this;if(!this._binded){this._binded=true;this._bind();this._map.addEventListener("moving",function(){i._hideCurrent()})}if(this._followTitle){this._map.addOverlay(this._followTitle);this._followTitle.hide()}var h=function(r){var m=i._map;if(!i._isOpen){return}r=window.event||r;var o=a.getDrawPoint(r,true);if(!i._isPointValid(o)){return}i._bind.initX=r.pageX||r.clientX||0;i._bind.initY=r.pageY||r.clientY||0;if(i._points.length>0){var u=m.pointToPixel(i._points[i._points.length-1]);var n=m.pointToPixel(o);var q=Math.sqrt(Math.pow(u.x-n.x,2)+Math.pow(u.y-n.y,2));if(q<5){return}}i._bind.x=r.layerX||r.offsetX||0;i._bind.y=r.layerY||r.offsetY||0;i._points.push(o);i._addSecPoint(o);if(i._paths.length==0){i._formatTitle(1,i._opts.followText,i._getTotalDistance())}if(i._paths.length>0){i._paths[i._paths.length-1].show();i._paths[i._paths.length-1].setStrokeOpacity(i._opts.opacity)}var x=new BMap.Polyline([o,o],{enableMassClear:i._enableMassClear});i._map.addOverlay(x);i._paths.push(x);i._overlays.push(x);x.setStrokeWeight(i._opts.lineStroke);x.setStrokeColor(i._opts.lineColor);x.setStrokeOpacity(i._opts.opacity/2);x.setStrokeStyle(i._opts.lineStyle);if(i._mapMoving){x.hide()}if(i._points.length>1){var p=i._paths[i._points.length-2];p.setPositionAt(1,o)}var s="";if(i._points.length>1){var v=i._setSegDistance(i._points[i._points.length-2],i._points[i._points.length-1]);var t=i._getTotalDistance();s=i._formatDisStr(t)}else{s="起点"}var w=new BMap.Label(s,{offset:new BMap.Size(10,-5),enableMassClear:i._enableMassClear});w.setStyles({color:"#333",borderColor:"#ff0103"});i._map.addOverlay(w);i._formatSegLabel(w,s);i._overlays.push(w);o.disLabel=w;w.setPosition(o);var l=new c.lang.Event("onaddpoint");l.point=o;l.pixel=i._map.pointToPixel(o);l.index=i._points.length-1;l.distance=i._getTotalDistance().toFixed(0);i.dispatchEvent(l)};var g=function(q){if(!i._isOpen){return}if(i._paths.length>0){q=window.event||q;var m=q.pageX||q.clientX||0;var l=q.pageY||q.clientY||0;if(typeof i._bind.initX=="undefined"){i._bind.x=q.layerX||q.offsetX||0;i._bind.y=q.layerY||q.offsetY||0;i._bind.initX=m;i._bind.initY=l}var s=i._bind.x+m-i._bind.initX;var r=i._bind.y+l-i._bind.initY;var A=i._paths[i._paths.length-1];var n=i._map.pixelToPoint(new BMap.Pixel(s,r));A.setPositionAt(1,n);if(!i._mapMoving){A.show()}var B=0;var v=0;if(s<10){B=8}else{if(s>i._map.getSize().width-10){B=-8}}if(r<10){v=8}else{if(r>i._map.getSize().height-10){v=-8}}if(B!=0||v!=0){if(!g._movingTimerId){i._mapMoving=true;i._map.panBy(B,v,{noAnimation:true});i._movingTimerId=g._movingTimerId=setInterval(function(){i._map.panBy(B,v,{noAnimation:true})},30);A.hide();i._followTitle&&i._followTitle.hide()}}else{if(g._movingTimerId){clearInterval(g._movingTimerId);delete g._movingTimerId;delete i._movingTimerId;var z=i._paths[i._paths.length-1];var w=i._map.pixelToPoint(new BMap.Pixel(s,r));if(!z){return}z.setPositionAt(1,w);z.show();if(i._followTitle){i._followTitle.setPosition(w);i._followTitle.show()}i._bind.i=0;i._bind.j=0;delete i._mapMoving}}if(i._followTitle){var p=i._getTotalDistance();var o=i._map.getDistance(i._points[i._points.length-1],n);i._updateInstDis(i._followTitle,p+o)}}else{if(i._followTitle){i._followTitle.show();q=window.event||q;var u=q.target||q.srcElement;if(u!=a.getDom()){i._followTitle.hide()}}}};var f=function(l){if(!i._isOpen){return}c.un(a.getDom(i._map),"click",h);c.un(document,"mousemove",g);c.un(a.getDom(i._map),"dblclick",f);c.un(document,"keydown",k);c.un(a.getDom(i._map),"mouseup",j);setTimeout(function(){i.close()},50)};var k=function(l){l=window.event||l;if(l.keyCode==27){i._clearCurData();setTimeout(function(){i.close()},50)}};var j=function(l){l=window.event||l;var m=0;if(/msie (\d+\.\d)/i.test(navigator.userAgent)){m=document.documentMode||+RegExp["\x241"]}if(m&&l.button!=1||l.button==2){i.close()}};i._initData();this._formatTitle();a.show(this._map);
this._setCursor(this._opts.cursor);c.on(a.getDom(this._map),"click",h);c.on(document,"mousemove",g);c.on(a.getDom(this._map),"dblclick",f);c.on(document,"keydown",k);c.on(a.getDom(this._map),"mouseup",j);this.bindFunc=[{elem:a.getDom(this._map),type:"click",func:h},{elem:a.getDom(this._map),type:"dblclick",func:f},{elem:document,type:"mousemove",func:g},{elem:document,type:"keydown",func:k},{elem:a.getDom(this._map),type:"mouseup",func:j}];return true};d.prototype._dispatchLastEvent=function(){var e=new c.lang.Event("ondrawend");e.points=this._points?this._points.slice(0):[];e.overlays=this._paths?this._paths.slice(0,this._paths.length-1):[];e.distance=this._getTotalDistance().toFixed(0);this.dispatchEvent(e)};d.prototype.close=function(){if(this._isOpen==false){return}this._isOpen=false;BMapLib._toolInUse=false;if(this._mapMoving){delete this._mapMoving}var g=this;g._dispatchLastEvent();if(g._points.length<2){g._clearCurData()}else{g._paths[g._paths.length-1].remove();g._paths[g._paths.length-1]=null;g._paths.length=g._paths.length-1;var h=g._points[g._points.length-1];if(h.disLabel){h.disLabel.remove()}g._processLastOp()}a.hide();for(var f=0,e=this.bindFunc.length;f<e;f++){c.un(this.bindFunc[f].elem,this.bindFunc[f].type,this.bindFunc[f].func)}if(g._movingTimerId){clearInterval(g._movingTimerId);g._movingTimerId=null}if(this._followTitle){this._followTitle.hide()}};d.prototype._clearCurData=function(){for(var f=0,e=this._points.length;f<e;f++){if(this._points[f].disLabel){this._points[f].disLabel.remove()}}for(var f=0,e=this._paths.length;f<e;f++){this._paths[f].remove()}for(var f=0,e=this._dots.length;f<e;f++){this._dots[f].remove()}this._initData()};d.prototype._initData=function(){this._points.length=0;this._paths.length=0;this._segDistance.length=0;this._dots.length=0};d.prototype._setSegDistance=function(g,f){if(!g||!f){return}var e=this._map.getDistance(g,f);this._segDistance.push(e);return e};d.prototype._getTotalDistance=function(){var g=0;for(var f=0,e=this._segDistance.length;f<e;f++){g+=this._segDistance[f]}return g};d.prototype._convertUnit=function(e,f){f=f||"metric";if(this._units[f]){return e*this._units[f].conv}return e};d.prototype._addSecPoint=function(g){var f=this._opts.secIcon?this._opts.secIcon:new BMap.Icon("http://api.map.baidu.com/images/mapctrls.png",new BMap.Size(11,11),{imageOffset:new BMap.Size(-26,-313)});var e=new BMap.Marker(g,{icon:f,clickable:false,baseZIndex:3500000,zIndexFixed:true,enableMassClear:this._enableMassClear});this._map.addOverlay(e);this._dots.push(e)};d.prototype._formatDisStr=function(h){var f=this._opts.unit;var g=this._units[f].u1;var e=this._convertUnit(h,f);if(e>this._units[f].incon){e=e/this._units[f].incon;g=this._units[f].u2;e=e.toFixed(1)}else{e=e.toFixed(0)}return e+g};d.prototype._setCursor=function(f){var e=/webkit/.test(navigator.userAgent.toLowerCase())?"url("+this._opts.cursor+") 3 6, crosshair":"url("+this._opts.cursor+"), crosshair";a._setCursor(e)};d.prototype._getCursor=function(){return this._opts.cursor};d.prototype._formatSegLabel=function(e,f){e.setStyle({"border":"none","padding":"0"});e.setContent("<span style='"+this._styles.BMapLib_diso+"'><span style='"+this._styles.BMapLib_disi+"'>"+f+"</span></span>")};d.prototype._processLastOp=function(){var i=this;delete i._bind.x;delete i._bind.y;delete i._bind.initX;delete i._bind.initY;if(i._paths.length>i._points.length-1){var g=i._paths.length-1;i._paths[g].remove();i._paths[g]=null;i._paths.length=g}var e={};e.points=i._points.slice(0);e.paths=i._paths.slice(0);e.dots=i._dots.slice(0);e.segDis=i._segDistance.slice(0);var j=i._map.pointToPixel(e.points[e.points.length-1]);var h=i._map.pointToPixel(e.points[e.points.length-2]);var k=[0,0];var f=[0,0];if(j.y-h.y>=0){f=[-5,11]}else{f=[-5,-35]}if(j.x-h.x>=0){k=[14,0]}else{k=[-14,0]}var n=e.points[e.points.length-1];n.disLabel=new BMap.Label("",{offset:new BMap.Size(-15,-40),enableMassClear:i._enableMassClear});n.disLabel.setStyles({color:"#333",borderColor:"#ff0103"});i._map.addOverlay(n.disLabel);n.disLabel.setOffset(new BMap.Size(f[0],f[1]));n.disLabel.setPosition(n);i._formatTitle(2,"","",n.disLabel);var m=this._opts.closeIcon?this._opts.closeIcon:new BMap.Icon("http://api.map.baidu.com/images/mapctrls.gif",new BMap.Size(12,12),{imageOffset:new BMap.Size(0,-14)});e.closeBtn=new BMap.Marker(e.points[e.points.length-1],{icon:m,offset:new BMap.Size(k[0],k[1]),baseZIndex:3600000,enableMassClear:i._enableMassClear});i._map.addOverlay(e.closeBtn);e.closeBtn.setTitle("清除本次测距");e.closeBtn.addEventListener("click",function(r){for(var p=0,o=e.points.length;p<o;p++){e.points[p].disLabel.remove();e.points[p].disLabel=null}for(var p=0,o=e.paths.length;p<o;p++){e.paths[p].remove();e.paths[p]=null}for(var p=0,o=e.dots.length;p<o;p++){e.dots[p].remove();e.dots[p]=null}e.closeBtn.remove();e.closeBtn=null;b(r);var q=new c.lang.Event("onremovepolyline");i.dispatchEvent(q)});i._initData()};d.prototype._formatTitle=function(g,l,e,i){var h=i||this._followTitle;
if(!h){return}h.setStyle({"lineHeight":"16px","zIndex":"85","padding":"3px 5px"});var n=this._startFollowText||"";var k=[];if(g==1){h.setOffset(0,25);var m=this._opts.unit;var j=this._units[m].u1;var f=this._convertUnit(e,m);if(f>this._units[m].incon){f=f/this._units[m].incon;j=this._units[m].u2;f=f.toFixed(1)}else{f=f.toFixed(0)}k.push("<span>总长：<span style='"+this._styles.BMapLib_disBoxDis+"'>"+f+"</span>"+j+"</span><br />");k.push("<span style='color:#7a7a7a'>"+l+"</span>")}else{if(g==2){var m=this._opts.unit;var j=this._units[m].u1;var f=this._convertUnit(this._getTotalDistance(),m);if(f>this._units[m].incon){f=f/this._units[m].incon;j=this._units[m].u2;f=f.toFixed(1)}else{f=f.toFixed(0)}k.push("总长：<span style='"+this._styles.BMapLib_disBoxDis+"'>"+f+"</span>"+j)}else{h.setOffset(0,25);k.push(n)}}h.setContent(k.join(""))};d.prototype._updateInstDis=function(g,e){var f=this._opts.unit;var i=this._units[f].u1;if(e>this._units[f].incon){e=e/this._units[f].incon;i=this._units[f].u2;e=e.toFixed(1)}else{e=e.toFixed(0)}if(g){var h=[];h.push("<span>总长：<span style='"+this._styles.BMapLib_disBoxDis+"'>"+e+"</span>"+i+"</span><br />");h.push("<span style='color:#7a7a7a'>"+this._opts.followText+"</span>");g.setContent(h.join(""))}};d.prototype._hideCurrent=function(){if(!this._isOpen){return}if(this._paths.length>0){var e=this._paths[this._paths.length-1];e.hide()}this._followTitle&&this._followTitle.hide()};d.prototype._isPointValid=function(h){if(!h){return false}var f=this._map.getBounds();var e=f.getSouthWest(),g=f.getNorthEast();if(h.lng<e.lng||h.lng>g.lng||h.lat<e.lat||h.lat>g.lat){return false}return true};var a={_map:null,_html:"<div style='background:transparent url(http://api.map.baidu.com/images/blank.gif);position:absolute;left:0;top:0;width:100%;height:100%;z-index:1000' unselectable='on'></div>",_maskElement:null,_cursor:"default",_inUse:false,show:function(e){this._map=e;this._inUse=true;if(!!this._maskElement){if(this._maskElement.remove){this._maskElement.remove()}else{this._maskElement.removeNode()}this._maskElement=""}if(!this._maskElement){this._createMask(e)}this._maskElement.style.display="block"},_createMask:function(g){this._map=g;if(!this._map){return}c.insertHTML(this._map.getContainer(),"beforeEnd",this._html);var f=this._maskElement=this._map.getContainer().lastChild;var e=function(h){b(h);return c.preventDefault(h)};c.on(f,"mouseup",function(h){if(h.button==2){e(h)}});c.on(f,"contextmenu",e);f.style.display="none"},getDrawPoint:function(h,j){h=window.event||h;var f=h.layerX||h.offsetX||0;var i=h.layerY||h.offsetY||0;var g=h.target||h.srcElement;if(g!=a.getDom(this._map)&&j==true){while(g&&g!=this._map.getContainer()){if(!(g.clientWidth==0&&g.clientHeight==0&&g.offsetParent&&g.offsetParent.nodeName.toLowerCase()=="td")){f+=g.offsetLeft;i+=g.offsetTop}g=g.offsetParent}}if(g!=a.getDom(this._map)&&g!=this._map.getContainer()){return}if(typeof f==="undefined"||typeof i==="undefined"){return}if(isNaN(f)||isNaN(i)){return}return this._map.pixelToPoint(new BMap.Pixel(f,i))},hide:function(){if(!this._map){return}this._inUse=false;if(this._maskElement){this._maskElement.style.display="none"}},getDom:function(e){if(!this._maskElement){this._createMask(e)}return this._maskElement},_setCursor:function(e){this._cursor=e||"default";if(this._maskElement){this._maskElement.style.cursor=this._cursor}}};function b(f){var f=window.event||f;f.stopPropagation?f.stopPropagation():f.cancelBubble=true}})();